<html>
<head>
	<!DOCTYPE html>
	<meta charset="utf-8">

	<link rel="stylesheet" href="bower_components/material-design-lite/material.min.css">
	<link rel="stylesheet" href="bower_components/material-design-icons/iconfont/material-icons.css">
	<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.blue-deep_orange.min.css">

	<style>
		body {
		  font: 10px sans-serif;
		}

		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}

		.line {
		  fill: none;
		  stroke-width: 1.5px;
		}

		.tooltip .circle{
		  fill: none;
		}

		.vertical{
			-webkit-appearance: slider-vertical;
		  height: 160px;
		  width: 10px;
		}

		.Critical {
			color: red;
		}

		.High {
			color: orange;
		}

		.Medium {
			color: blue;
		}

		.Low {
			color: green;
		}

		.nmars-pref {
			left: calc(100% - 32px);
			position: relative;
		}

		.slides {
			width: 200px;
		}

		#regression {
			position: relative;;
		}

		#line {
			position: absolute;
		}

		.nmars-pref {
			position: absolute;
			right: 0;
		}

		.mdl-data-table th {
			text-align: center;
		}

		.mdl-button--file input {
		  cursor: pointer;
		  height: 100%;
		  right: 0;
		  opacity: 0;
		  position: absolute;
		  top: 0;
		  width: 300px;
		  z-index: 4;
		}

		.mdl-textfield--file .mdl-textfield__input {
		  box-sizing: border-box;
		  width: calc(100% - 32px);
		}
		.mdl-textfield--file .mdl-button--file {
		  right: 0;
		}
	</style>
</head>
<body>
<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <header class="mdl-layout__header">
    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title">Banding Demo</span>
      <!-- Add spacer, to align navigation to the right -->
      <div class="mdl-layout-spacer"></div>
      <!-- Navigation. We hide it in small screens. -->
      <nav class="mdl-navigation mdl-layout--large-screen-only">
			<!-- <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a> -->
        <!-- Right aligned menu below button -->
				<button id="demo-menu-lower-right"
				        class="mdl-button mdl-js-button mdl-button--icon">
				  <i class="material-icons">more_vert</i>
				</button>

				<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
				    for="demo-menu-lower-right">
				  <li class="mdl-menu__item">Login</li>
				  <li class="mdl-menu__item">Preferences</li>
				</ul>
      </nav>
    </div>
  </header>

  <div class="mdl-layout__drawer">
    <span class="mdl-layout-title">Banding Demo</span>
    <nav class="mdl-navigation">
    <!-- <a class="mdl-navigation__link" href="">Link</a>
      <a class="mdl-navigation__link" href="">Link</a>
      <a class="mdl-navigation__link" href="">Link</a>
      <a class="mdl-navigation__link" href="">Link</a> -->
    </nav>
  </div>

  <main class="mdl-layout__content">
	  <div id="controls"  class="mdl-grid">
			<div class="mdl-cell mdl-cell--2-col mdl-cell--1-offset">
		  	<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent show-modal">External Data</button>
		  </div>

	  	<div class="mdl-cell mdl-cell--1-col mdl-shadow--2dp mdl-cell--1-offset" style="padding: 0 10;">
	  		<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			    <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="days" onchange="generator.days(parseInt(this.value)); stats.days(parseInt(this.value));">
			    <label class="mdl-textfield__label" for="days">Days...</label>
			    <span class="mdl-textfield__error">Input is not a number!</span>
			  </div>
		  </div>

		  <div class="mdl-cell mdl-cell--2-col mdl-shadow--2dp">
	  		<h2 id="band" style="text-align: center; margin: 0px; padding: 10;"></h2>
	  	</div>

		  <div class="mdl-cell mdl-cell--2-col mdl-shadow--2dp">
		  		<h2 id="p95" style="text-align: center; margin: 0px; padding: 10;"></h2>
		  </div>

		  <div class="mdl-cell mdl-cell--2-col mdl-cell--1-offset">
		  	<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
		  					onclick="data = generator.calculate(); update(data);">Random Data</button>
		  </div>
	  </div>

	  <div class="mdl-grid">
	  	<div id="regression" class="mdl-cell mdl-cell--5-col mdl-shadow--2dp">
		  	<div id="line"></div>
		  	<div id="wrapper" class="nmars-pref">
		  		<button id="line-pref" class="mdl-button mdl-js-button mdl-button--icon">
					  <i class="material-icons">more_vert</i>
					</button>

					<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect slides" data-mdl-for="line-pref">
					  <li class="mdl-menu__item">
					  	<p>
					    	<label class="" for="amplitude">Amplitude:</label>
						  	<input id="amplitude" class="mdl-slider mdl-js-slider" type="range" min="0" max="100" value="40" onchange="generator.amplitude(parseInt(this.value)); update(data);" />
						  	<output></output>
						  </p>
					  </li>
					  <li class="mdl-menu__item">
					  	<p>
						  	<label class="" for="growth">Growth:</label>
						  	<input id="growth" class="mdl-slider mdl-js-slider" type="range" min="0" max="100" value="25" tabindex="0" onchange="generator.growth(parseInt(this.value)); update(data);" />
						  </p>
					  </li>
					</ul>
				</div>
		  </div>
		  <div id="bar" class="mdl-cell mdl-cell--2-col mdl-shadow--2dp">
				<div id="bar-1"></div>
			</div>
			<div class="mdl-cell mdl-cell--5-col mdl-shadow--2dp">
		  	<div id="histo"></div>
		  </div>

		</div>

		<div class="mdl-grid">
	  	
		 <!--  <div id="scatter" class="mdl-cell mdl-cell--5-col mdl-shadow--2dp">
				<div id="scatter-1"></div>
			</div> -->
		</div>

		<div class="mdl-grid">
			<div class="mdl-cell mdl-cell--2-col mdl-cell--5-offset">
		  	<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
		  					onclick="reset();">Clear Table</button>
		  </div>
		</div>

		<div class="mdl-grid">
			<table class="mdl-data-table mdl-js-data-table mdl-cell mdl-cell--12-col mdl-shadow--2dp">
				<colgroup>
					<col span="3">
					<col span="2" style="background: #CCC">
					<col span="4">
					<col span="4" style="background: #CCC">
					<col span="1">
				</colgroup>
		  	<thead>
			  	<tr>
			  		<th rowspan="2">Run</th>
			  		<th rowspan="2">Min</th>
			  		<th rowspan="2">Max</th>
			  		<th colspan="2">Quartiles</th>
			  		<th rowspan="2">Mean</th>
			  		<th rowspan="2">Deviation</th>
			  		<th rowspan="2">Varience</th>
			  		<th rowspan="2">Days</th>
			  		<th colspan="4">Bands</th>
			  		<th rowspan="2">Band</th>
			  	</tr>
			  	<tr>
			  		<th>Lower</th>
			  		<th>Upper</th>
			  		<th>Low</th>
			  		<th>Medium</th>
			  		<th>High</th>
			  		<th>Critical</th>
			  	</tr>
			  </thead>
			  <tbody id="tableBody">
			  </tbody>
			</table>
		</div>

	</main>
</div>

<dialog class="mdl-dialog">
	<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">

	  <div class="mdl-tabs__tab-bar">
	      <a href="#file-panel" class="mdl-tabs__tab is-active">From File</a>
	      <a href="#server-panel" class="mdl-tabs__tab">From Server</a>
	  </div>

	  <div class="mdl-tabs__panel is-active mdl-dialog__content" id="file-panel">
			<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-1">
			  <input type="radio" id="option-1" class="mdl-radio__button" name="bias" value="E" checked>
			  <span class="mdl-radio__label">Egress</span>
			</label>
			<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-2">
			  <input type="radio" id="option-2" class="mdl-radio__button" name="bias" value="I">
			  <span class="mdl-radio__label">Ingress</span>
			</label>

	    <div class="mdl-textfield mdl-js-textfield mdl-textfield--file">
		    <input class="mdl-textfield__input" placeholder="File" type="text" id="uploadFile" name="file" readonly/>
		    <div class="mdl-button mdl-button--primary mdl-button--icon mdl-button--file">
		      <i class="material-icons">attach_file</i><input type="file" id="uploadBtn">
		    </div>
		  </div>
	  </div>

	  <div class="mdl-tabs__panel mdl-dialog__content" id="server-panel">
	  	<div class="mdl-grid">
	  		<div class="mdl-cell mdl-cell--8-col">
			    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" id="node" name="server">
				    <label class="mdl-textfield__label" for="node">CLLI...</label>
				  </div>
				</div>
				<div class="mdl-cell mdl-cell--4-col">
				  <button id="lookup" class="mdl-button mdl-js-button mdl-button--raised">
					  Lookup
					</button>
				</div>
			</div>
			<div class="mdl-grid">
				<select id="port"></select>
				<input type="hidden" id="neModel" value="false" />
			</div>
	  </div>

	</div>
	<div class="mdl-dialog__actions mdl-dialog__actions">
    <button type="button" class="mdl-button" onClick="loadData();">Load</button
>    <button type="button" class="mdl-button close">Cancel</button>
  </div>
</dialog>
<script>
	var dialog = document.querySelector('dialog');
  var showModalButton = document.querySelector('.show-modal');

  if (! dialog.showModal) {
    dialogPolyfill.registerDialog(dialog);
  }

  showModalButton.addEventListener('click', function() {
    dialog.showModal();
  });

  dialog.querySelector('.close').addEventListener('click', function() {
    dialog.close();
  });

  document.getElementById("uploadBtn").onchange = function () {
    document.getElementById("uploadFile").value = this.files[0].name;
	};
</script>
</body>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/material-design-lite/material.min.js"></script>
<script src="bower_components/regression-js/src/regression.js"></script>
<script src="bower_components/d3/d3.js"></script>
<script src="bower_components/papaparse/papaparse.min.js"></script>
<script src="d3.line.js"></script>
<script src="d3.multiLine.js"></script>
<script src="d3.bar.js"></script>
<!-- <script src="d3.donut.js"></script> -->
<script src="generator.js"></script>
<script src="d3.scatter.js"></script>
<script src="d3.histogram.js"></script>
<script src="stats.js"></script>

<script>

	/*
	* Create graphs
	*/
	var run = 0;

	var days = 7;
	var generator = new Generator();
	var stats = new Stats();
	var regData, bands, band, p95, data;

	generator.days(days).amplitude(40).growth(25);
	stats.days(days);

	var data = generator.calculate();

	var line2 = multiLine()
		.$el(d3.select("#line"))
		.height(200)
		.color(['steelblue','violet']);

	var bar = bar()
		.$el(d3.select("#bar-1"))
		.color(["green", "blue", "orange", "red"])
		.labelColor(["black", "white", "black", "black"]);

	// var scatter = scatter()
	// 	.$el(d3.select("#scatter-1"));

	var histo = histogram()
		.$el(d3.select("#histo"))
		.height(200)
		.binCount(20);

	window.onresize = function(){
		update(data);
	};

	window.onload = function(){
		generator.calculate();
		update(data);	
	};

	function update(data){	
		stats.data(data);
		regData = regressionData(data);
		bands = stats.bands();
		band = stats.band();
		p95 = stats.threshold(stats.percentile(95));

		appendTable(stats.stats());

		var lineWidth = document.getElementById('regression').offsetWidth;
		var barWidth = document.getElementById('bar').offsetWidth;
		// var scatterWidth = document.getElementById('scatter').offsetWidth;
		var histoWidth = document.getElementById('histo').offsetWidth;

		line2.width(lineWidth)
			.data([data, regData.line]).render();

		bar.width(barWidth)
			.data(bands).render();
		// scatter.width(scatterWidth)
		// 	.data(regData.scatter.data).render();
		histo.width(histoWidth)
			.data(histoData(data)).render();

		d3.select('#band').attr('class', band).text(band);
		d3.select('#p95').attr('class', p95).text(p95);
	}

	function reset(){
		$('#tableBody').empty();
	}

	function appendTable(data){
		var output = "<tr><td>" + run + "</td>";
		run++;
		$.each(data, function(key, value){
			if($.isPlainObject(value)){
				$.each(value, function(key, value){
					output += "<td>";
					output += value;
					output += "</td>";	
				});
			}else{
				output += "<td>";
				output += value;
				output += "</td>";
			}
		});
		output += "</tr>";
		$("tbody").prepend(output);
	}

	function regressionPrep(data){
		var tempAry = [];
		data.forEach(function(d){
			tempAry.push([d.x, d.y]);
		});
		return tempAry;
	}

	function regressionReturn(data){
		var tempAry = [];
		data.forEach(function(d, i){
			tempAry.push({x: d[0], y: d[1]});
		});
		return tempAry;
	}

	function difference(data1, data2){
		var output = {
			mean: false,
			variance: false,
			data: []
		};
		
		data1.forEach(function(d, i){
			output.data.push({x: i, y: (d.y - data2[i].y)});
		});

		output.mean = d3.mean(function(d){ return d.y; });
		output.variance = d3.variance(function(d){ return d.y; });

		return output;
	}

	function regressionData(data){
		var regressionObj = {
			line: [],
			scatter: []
		};
		var chunk = 96;
		var j = 0;
		for(var i = 0; i < data.length/chunk; i++){
			var tempAry = data.slice(i*96, (i+1)*chunk);
			regressionReturn(regression('polynomial', regressionPrep(tempAry), 4).points).forEach(function(d){
				regressionObj.line.push({x: j, y: d.y});
				j++;
			});
		}
		regressionObj.scatter = difference(data, regressionObj.line);

		return regressionObj;
	}

	function histoData(data){
		var tempAry = [];
		data.forEach(function(d){
			tempAry.push(d.y);
		});
		return tempAry;
	}

	function loadData(){
		// Debating an attempt at having this be a two fold approach.
		// First ask if the user would like to load from CSV or remote. Then load the data appropriately.
		var bias = "EUSG";
		if($("input[name='bias']:checked").val() !== "E"){
			bias = "IUSG";
		}

		if($("input[name='file']").val() !== ""){
			var config = {
				header: true,
				complete: function(results, file) {
					console.log("Parsing complete:", results, file);
				}
			};
			Papa.parse(document.getElementById('uploadBtn').files[0], {
				header: true,
				complete: function(results, file) {
					var tempData = [];
					results.data.forEach(function(d,i){
						tempData.push({ x: +i, y: +d[bias]});
					});
					update(tempData);
					console.log("Parsing complete:", results, file);
					dialog.close();
				}
			});
		}else if($("input[name='server']").val() !== ""){
			var url = "http://protonmars.dev/scripts/NetOp/index.php";
			var lookup = {
				necompid: $('#port').val(),
				nemodel: 	$('#neModel').val(),
				rtype: 		"u",
				dateoff: 	14
			};

			$.getJSON(url, lookup)
			.success(function(data){
				var tempData = [];
				data.forEach(function(d,i){
					tempData.push({ x: +i, y: +d[bias]});
				});
				update(tempData);
				dialog.close();
			})
			.fail(function(error){
				console.log("Fail", error);
			});
		}else{
			alert("Error!");
		}
	}

$('#lookup').on('click', function(e){
	var node = $('#node').val() || false;
	if(node){
		$.getJSON("lookup.php", { node: node	})
		.success(function(data){
			console.log("Success", data);
			var $el = $('#port');
			$el.empty();

			$.each(data.ports, function(i, d){
				$el.append($("<option></option>")
    			.attr("value", d.neComp).text(d.Index));
			});

			$("#neModel").val(data.info.neModel);
		})
		.fail(function(error){
			console.log("Fail", error);
		});
	}else{
		alert("Please enter a CLLI code.");
		return;
	}
});

</script>
</html>